

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Azure Resource Manager Template</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'deploy/azure/arm';</script>
    <link rel="canonical" href="https://cloud-katana.com/deploy/azure/arm.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Design Principles" href="../../learn/principles/intro.html" />
    <link rel="prev" title="Deploy to Azure" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/Logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/Logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="intro.html">Deploy to Azure</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Azure Resource Manager Template</a></li>



</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Internals</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../learn/principles/intro.html">Design Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../learn/schema.html">Attack Scenario Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../learn/simulation.html">Request Simulations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Notebook Campaigns</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../simulate/azure/intro.html">Azure</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../simulate/azure/attackscenario-7dde2208-d4eb-480e-afa1-bad0ab7e861b.html">Admin promotion via Directory Role Permission Grant</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../simulate/azure/attackscenario-7d918ee0-6928-48c5-8cf9-5dfb88abc7c4.html">Azure AD Light Discovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../simulate/azure/attackscenario-81b67a16-5218-41e6-8c6d-1fc6a10b757a.html">Add New Password Credential to Azure AD Application and Read Mail</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Azure/Cloud-Katana" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Azure/Cloud-Katana/edit/main/docs/deploy/azure/arm.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Azure/Cloud-Katana/issues/new?title=Issue%20on%20page%20%2Fdeploy/azure/arm.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/deploy/azure/arm.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Azure Resource Manager Template</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Azure Resource Manager Template</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authenticate-to-azure">Authenticate to Azure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clone-project">Clone Project</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#import-cloud-katana-tools-powershell-module">Import Cloud Katana Tools PowerShell Module</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-variables">Define Variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-access-token-for-azure-resource-management-api">Get Access Token for Azure Resource Management API</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#request-a-device-code">Request a Device Code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieve-access-token">Retrieve Access Token</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-resource-group">Create Resource Group</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-user-assigned-managed-identity">Create a User Assigned Managed Identity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-access-token-for-microsoft-graph-api">Get Access Token for Microsoft Graph API</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Request a Device Code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Retrieve Access Token</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grant-permissions-to-managed-identity">Grant Permissions to Managed Identity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deploy-arm-template">Deploy ARM Template</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#azure-cli">Azure CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deploy-button">Deploy Button</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monitor-deployment">Monitor Deployment</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="azure-resource-manager-template">
<h1>Azure Resource Manager Template<a class="headerlink" href="#azure-resource-manager-template" title="Permalink to this heading">#</a></h1>
<section id="authenticate-to-azure">
<h2>Authenticate to Azure<a class="headerlink" href="#authenticate-to-azure" title="Permalink to this heading">#</a></h2>
<p>Use the Azure CLI command <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">login</span></code> to authenticate to Azure AD with an account to deploy resources in Azure.</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="n">az</span> <span class="n">login</span> <span class="p">-</span><span class="n">-tenant</span> <span class="n">xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span>
</pre></div>
</div>
</section>
<section id="clone-project">
<h2>Clone Project<a class="headerlink" href="#clone-project" title="Permalink to this heading">#</a></h2>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">://</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="p">/</span><span class="n">Azure</span><span class="p">/</span><span class="n">Cloud-Katana</span>
</pre></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="import-cloud-katana-tools-powershell-module">
<h1>Import Cloud Katana Tools PowerShell Module<a class="headerlink" href="#import-cloud-katana-tools-powershell-module" title="Permalink to this heading">#</a></h1>
<p>This module is based on the <a class="reference external" href="https://www.powershellgallery.com/packages/CloudKatanaAbilities">Cloud Katana abilities</a> module available in the project.</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">CloudKatanaTools</span><span class="p">.</span><span class="n">psm1</span> <span class="n">-Verbose</span>
</pre></div>
</div>
<section id="define-variables">
<h2>Define Variables<a class="headerlink" href="#define-variables" title="Permalink to this heading">#</a></h2>
<p>We are going to define a few variables for the whole setup</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$AADPowerShellAppId</span> <span class="p">=</span> <span class="s1">&#39;1b730954-1685-4b74-9bfd-dac224a7b894&#39;</span>
<span class="nv">$AzManagementUrl</span> <span class="p">=</span> <span class="s1">&#39;https://management.azure.com&#39;</span>
<span class="nv">$MSGraphUrl</span> <span class="p">=</span> <span class="s1">&#39;https://graph.microsoft.com&#39;</span>
<span class="nv">$SubscriptionId</span> <span class="p">=</span> <span class="s1">&#39;&lt;SUBSCRIPTION-ID&gt;&#39;</span>
<span class="nv">$ResourceGroupName</span> <span class="p">=</span> <span class="s1">&#39;&lt;RESOURCE-GROUP-NAME&gt;&#39;</span> <span class="c"># If it doesn&#39;t exists, it is created</span>
<span class="nv">$FunctionAppName</span> <span class="p">=</span> <span class="p">(</span><span class="n">-join</span> <span class="p">(</span><span class="s1">&#39;cloudkatana&#39;</span><span class="p">,</span><span class="n">-join</span> <span class="p">((</span><span class="n">65</span><span class="p">..</span><span class="n">90</span><span class="p">)</span> <span class="p">+</span> <span class="p">(</span><span class="n">97</span><span class="p">..</span><span class="n">122</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Get-Random</span> <span class="n">-Count</span> <span class="n">10</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span><span class="no">[char]</span><span class="nv">$_</span><span class="p">}))).</span><span class="n">ToLower</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="get-access-token-for-azure-resource-management-api">
<h2>Get Access Token for Azure Resource Management API<a class="headerlink" href="#get-access-token-for-azure-resource-management-api" title="Permalink to this heading">#</a></h2>
<p>We need get an access token to use it with the Azure Resource Management API to create an Azure Resource Group and a User-Assigned Managed Identity to deploy Cloud Katana resources.</p>
<section id="request-a-device-code">
<h3>Request a Device Code<a class="headerlink" href="#request-a-device-code" title="Permalink to this heading">#</a></h3>
<p>Request a device code with the Azure Active Directory PowerShell application (app ID: <code class="docutils literal notranslate"><span class="pre">1b730954-1685-4b74-9bfd-dac224a7b894</span></code>) for the Azure Resource Management <code class="docutils literal notranslate"><span class="pre">https://management.azure.com</span></code>. To sign in, use a web browser to open the page <a class="reference external" href="https://microsoft.com/devicelogin">https://microsoft.com/devicelogin</a> and enter the code XXXX to authenticate</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$AzMgmtDCRequest</span> <span class="p">=</span> <span class="nb">Get-CKDeviceCode</span> <span class="n">-ClientId</span> <span class="nv">$AADPowerShellAppId</span> <span class="n">-Resource</span> <span class="nv">$AzManagementUrl</span>
<span class="nv">$AzMgmtDCRequest</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_code</span>        <span class="p">:</span> <span class="n">XXXX</span>
<span class="n">device_code</span>      <span class="p">:</span> <span class="n">XXXX</span>
<span class="n">verification_url</span> <span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">devicelogin</span>
<span class="n">expires_in</span>       <span class="p">:</span> <span class="mi">900</span>
<span class="n">interval</span>         <span class="p">:</span> <span class="mi">5</span>
<span class="n">message</span>          <span class="p">:</span> <span class="n">To</span> <span class="n">sign</span> <span class="ow">in</span><span class="p">,</span> <span class="n">use</span> <span class="n">a</span> <span class="n">web</span> <span class="n">browser</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">page</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">devicelogin</span> <span class="ow">and</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">code</span> <span class="n">XXXX</span> <span class="n">to</span> <span class="n">authenticate</span><span class="o">.</span>
</pre></div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="retrieve-access-token">
<h1>Retrieve Access Token<a class="headerlink" href="#retrieve-access-token" title="Permalink to this heading">#</a></h1>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$AzMgmtTokens</span> <span class="p">=</span> <span class="nb">Get-CKAccessToken</span> <span class="n">-ClientId</span> <span class="nv">$AADPowerShellAppId</span> <span class="n">-Resource</span> <span class="nv">$AzManagementUrl</span> <span class="n">-GrantType</span> <span class="n">device_code</span> <span class="n">-DeviceCode</span> <span class="nv">$AzMgmtDCRequest</span><span class="p">.</span><span class="n">device_code</span>
<span class="nv">$AzMgmtAccessToken</span> <span class="p">=</span> <span class="nv">$AzMgmtTokens</span><span class="p">.</span><span class="n">access_token</span>
</pre></div>
</div>
<section id="create-resource-group">
<h2>Create Resource Group<a class="headerlink" href="#create-resource-group" title="Permalink to this heading">#</a></h2>
<p>Create a resource group to deploy all Cloud Katana resources in it.</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$resourceGroup</span> <span class="p">=</span> <span class="nb">New-CKAzResourceGroup</span> <span class="n">-name</span> <span class="nv">$ResourceGroupName</span> <span class="n">-location</span> <span class="n">eastus</span> <span class="n">-subscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-accessToken</span> <span class="nv">$AzMgmtAccessToken</span>
</pre></div>
</div>
</section>
<section id="create-a-user-assigned-managed-identity">
<h2>Create a User Assigned Managed Identity<a class="headerlink" href="#create-a-user-assigned-managed-identity" title="Permalink to this heading">#</a></h2>
<p>Besides using <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">Azure Functions</a> to orchestrate attack simulations, Cloud Katana leverages the following resources for additional capabilities:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">AD</span> <span class="pre">application</span> <span class="pre">(Server)</span></code>: Enables authentication and authorization features via Azure AD.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">AD</span> <span class="pre">application</span> <span class="pre">(Client)</span></code>: A native application used to interact with Cloud Katana’s serverless API. This is part of the authentication and authorization process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">User-assigned</span> <span class="pre">managed</span> <span class="pre">identity</span></code>: Facilitates the granular access control to other Azure AD protected resources. Permissions required to execute each simulation task need to be granted to the Cloud Katana’s managed identity.</p></li>
</ul>
<p>The registration of new Azure AD applications and permission grants are done via <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/templates/deployment-script-template">custom scripts in the ARM template</a>. These custom scripts need to be executed under the security context of an identity with the right permissions to do so. Rather than passing credentials to the ARM template, we use a <a class="reference external" href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp">user-assigned managed identity</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To create a user-assigned managed identity, your account needs the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#managed-identity-contributor">Managed Identity Contributor role</a>.</p>
</div>
<p>Run the following PowerShell commands to create a new user-assigned managed identity:</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$IdentityName</span> <span class="p">=</span> <span class="s1">&#39;&lt;USER-ASSIGNED-MANAGED-IDENTITY&gt;&#39;</span>
<span class="nv">$Identity</span> <span class="p">=</span> <span class="nb">New-CKAzADManagedIdentity</span> <span class="n">-name</span> <span class="nv">$IdentityName</span> <span class="n">-subscriptionId</span> <span class="nv">$SubscriptionId</span> <span class="n">-resourceGroupName</span> <span class="nv">$ResourceGroupName</span> <span class="n">-accessToken</span> <span class="nv">$AzMgmtAccessToken</span>
</pre></div>
</div>
</section>
<section id="get-access-token-for-microsoft-graph-api">
<h2>Get Access Token for Microsoft Graph API<a class="headerlink" href="#get-access-token-for-microsoft-graph-api" title="Permalink to this heading">#</a></h2>
<p>We need get an access token to use it with the Microsoft Graph API to grant permissions to the User-Assigned Managed Identity, created in the previous step, to deploy Cloud Katana.</p>
<section id="id1">
<h3>Request a Device Code<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>Request a device code with the Azure Active Directory PowerShell application (app ID: 1b730954-1685-4b74-9bfd-dac224a7b894) for the Microsoft Graph <code class="docutils literal notranslate"><span class="pre">https://graph.microsoft.com</span></code>. To sign in, use a web browser to open the page <a class="reference external" href="https://microsoft.com/devicelogin">https://microsoft.com/devicelogin</a> and enter the code XXXX to authenticate</p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$MSGraphDCRequest</span> <span class="p">=</span> <span class="nb">Get-CKDeviceCode</span> <span class="n">-ClientId</span> <span class="nv">$AADPowerShellAppId</span> <span class="n">-Resource</span> <span class="nv">$MSGraphUrl</span>
<span class="nv">$MSGraphDCRequest</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_code</span>        <span class="p">:</span> <span class="n">XXXX</span>
<span class="n">device_code</span>      <span class="p">:</span> <span class="n">XXXX</span>
<span class="n">verification_url</span> <span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">devicelogin</span>
<span class="n">expires_in</span>       <span class="p">:</span> <span class="mi">900</span>
<span class="n">interval</span>         <span class="p">:</span> <span class="mi">5</span>
<span class="n">message</span>          <span class="p">:</span> <span class="n">To</span> <span class="n">sign</span> <span class="ow">in</span><span class="p">,</span> <span class="n">use</span> <span class="n">a</span> <span class="n">web</span> <span class="n">browser</span> <span class="n">to</span> <span class="nb">open</span> <span class="n">the</span> <span class="n">page</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">devicelogin</span> <span class="ow">and</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">code</span> <span class="n">XXXX</span> <span class="n">to</span> <span class="n">authenticate</span><span class="o">.</span>
</pre></div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id2">
<h1>Retrieve Access Token<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h1>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$MSGraphTokens</span> <span class="p">=</span> <span class="nb">Get-CKAccessToken</span> <span class="n">-ClientId</span> <span class="nv">$AADPowerShellAppId</span> <span class="n">-Resource</span> <span class="nv">$MSGraphUrl</span> <span class="n">-GrantType</span> <span class="n">device_code</span> <span class="n">-DeviceCode</span> <span class="nv">$MSGraphDCRequest</span><span class="p">.</span><span class="n">device_code</span>
<span class="nv">$MSGraphAccessToken</span> <span class="p">=</span> <span class="nv">$MSGraphTokens</span><span class="p">.</span><span class="n">access_token</span>
</pre></div>
</div>
<section id="grant-permissions-to-managed-identity">
<h2>Grant Permissions to Managed Identity<a class="headerlink" href="#grant-permissions-to-managed-identity" title="Permalink to this heading">#</a></h2>
<p>Once the managed identity is created, we need to grant all the required permissions to register new Azure AD applications and grant permissions to the deployment managed identity. The following permissions must be granted:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Application.ReadWrite.All</span></code>: Allows the calling app to create, and manage (read, update, update application secrets and delete) applications and service principals without a signed-in user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AppRoleAssignment.ReadWrite.All</span></code>: Allows the app to manage permission grants for application permissions to any API (including Microsoft Graph) and application assignments for any app, without a signed-in user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DelegatedPermissionGrant.ReadWrite.All</span></code>: Allows the app to grant or revoke any delegated permission for any API (including Microsoft Graph), without a signed-in user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">User.Read.All</span></code>: Allows the app to read the full set of profile properties, group membership, reports and managers of other users in your organization, without a signed-in user.</p></li>
</ul>
<p><strong>Reference</strong>: <a class="reference external" href="https://docs.microsoft.com/en-us/graph/permissions-reference#application-permissions-4">https://docs.microsoft.com/en-us/graph/permissions-reference#application-permissions-4</a></p>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nb">Grant-CKAzADAppPermissions</span> <span class="n">-spObjectId</span> <span class="nv">$Identity</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">principalId</span> <span class="n">-resourceName</span> <span class="s1">&#39;Microsoft Graph&#39;</span> <span class="n">-Permissions</span> <span class="p">@(</span><span class="s1">&#39;Application.ReadWrite.All&#39;</span><span class="p">,</span><span class="s1">&#39;AppRoleAssignment.ReadWrite.All&#39;</span><span class="p">,</span><span class="s1">&#39;DelegatedPermissionGrant.ReadWrite.All&#39;</span><span class="p">,</span><span class="s1">&#39;User.Read.All&#39;</span><span class="p">)</span> <span class="n">-permissionType</span> <span class="n">application</span> <span class="n">-accessToken</span> <span class="nv">$MSGraphAccessToken</span> <span class="n">-verbose</span>
</pre></div>
</div>
</section>
<section id="deploy-arm-template">
<h2>Deploy ARM Template<a class="headerlink" href="#deploy-arm-template" title="Permalink to this heading">#</a></h2>
<p>Deploy Cloud Katana to Azure with the <code class="docutils literal notranslate"><span class="pre">azuredeploy.json</span></code> ARM template available at the root of the project’s folder. You can run the template with <a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/what-is-azure-cli">Azure CLI</a> or a <code class="docutils literal notranslate"><span class="pre">Deploy</span></code> button (One-click deployment).</p>
<section id="azure-cli">
<h3>Azure CLI<a class="headerlink" href="#azure-cli" title="Permalink to this heading">#</a></h3>
<div class="highlight-PowerShell notranslate"><div class="highlight"><pre><span></span><span class="nv">$identityId</span> <span class="p">=</span> <span class="nv">$identity</span><span class="p">.</span><span class="n">id</span>
<span class="nv">$assignAppRoleToUser</span> <span class="p">=</span> <span class="s1">&#39;USER@DOMAIN.COM&#39;</span>

<span class="n">az</span> <span class="n">deployment</span> <span class="nb">group </span><span class="n">create</span> <span class="p">-</span><span class="n">-template</span><span class="o">-file</span> <span class="n">azuredeploy</span><span class="p">.</span><span class="n">json</span> <span class="p">-</span><span class="n">-resource-group</span> <span class="nv">$resourceGroup</span> <span class="p">-</span><span class="n">-parameters</span> <span class="n">functionAppName</span><span class="p">=</span><span class="nv">$functionAppName</span> <span class="n">identityId</span><span class="p">=</span><span class="nv">$identityId</span> <span class="n">assignAppRoleToUser</span><span class="p">=</span><span class="nv">$assignAppRoleToUser</span>
</pre></div>
</div>
</section>
<section id="deploy-button">
<h3>Deploy Button<a class="headerlink" href="#deploy-button" title="Permalink to this heading">#</a></h3>
<p>You can also click on the button <code class="docutils literal notranslate"><span class="pre">Deploy</span></code> below and provide the <code class="docutils literal notranslate"><span class="pre">required</span></code> parameter values used in the previous Azure CLI deployment section.</p>
<p><a class="reference external" href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3a%2f%2fraw.githubusercontent.com%2fAzure%2fCloud-Katana%2fmain%2fazuredeploy.json"><img alt="Deploy to Azure" src="https://aka.ms/deploytoazurebutton" /></a></p>
</section>
</section>
<section id="monitor-deployment">
<h2>Monitor Deployment<a class="headerlink" href="#monitor-deployment" title="Permalink to this heading">#</a></h2>
<p>Go to <a class="reference external" href="https://portal.azure.com/">https://portal.azure.com</a> &gt; <code class="docutils literal notranslate"><span class="pre">&lt;RESOURCE-GROUP-NAME&gt;</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">Deployments</span></code> to monitor the deployment of Cloud Katana’s resources:</p>
<p><img alt="" src="../../_images/MonitorDeployment.png" /></p>
<p>If you go back to your resource group, you will see everything that is being created:</p>
<p><img alt="" src="../../_images/ResourcesCreated.png" /></p>
<p>You can click, for example, on one of the <code class="docutils literal notranslate"><span class="pre">deployment</span> <span class="pre">scripts</span></code> artifacts and inspect the logs to see what the scripts is doing as shown below:</p>
<p><img alt="" src="../../_images/RunningDeploymentScripts.png" /></p>
<p>Finally, when the Cloud Katana Azure function is deployed, you can go back to your group resources and click on the <code class="docutils literal notranslate"><span class="pre">Function</span> <span class="pre">App</span></code> resource. Then, you can click on <code class="docutils literal notranslate"><span class="pre">Functions</span></code> and you will be able to explore all the Azure functions associated with the Cloud Katana serverless API.</p>
<p><img alt="" src="../../_images/KatanaFunctions.png" /></p>
<p>Let’s click on the <code class="docutils literal notranslate"><span class="pre">Activity</span> <span class="pre">Function</span></code> named <code class="docutils literal notranslate"><span class="pre">Azure</span></code>. This one is used to execute actions in Azure. Next, click on <code class="docutils literal notranslate"><span class="pre">Code</span> <span class="pre">+Test</span></code> to look at the code behind the activity function.</p>
<p><img alt="" src="../../_images/KatanaFunctionsCode.png" /></p>
<p>That’s it!</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "Azure/Cloud-Katana",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./deploy\azure"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Deploy to Azure</p>
      </div>
    </a>
    <a class="right-next"
       href="../../learn/principles/intro.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Design Principles</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Azure Resource Manager Template</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authenticate-to-azure">Authenticate to Azure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#clone-project">Clone Project</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#import-cloud-katana-tools-powershell-module">Import Cloud Katana Tools PowerShell Module</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#define-variables">Define Variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-access-token-for-azure-resource-management-api">Get Access Token for Azure Resource Management API</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#request-a-device-code">Request a Device Code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieve-access-token">Retrieve Access Token</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-resource-group">Create Resource Group</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-user-assigned-managed-identity">Create a User Assigned Managed Identity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-access-token-for-microsoft-graph-api">Get Access Token for Microsoft Graph API</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Request a Device Code</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Retrieve Access Token</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grant-permissions-to-managed-identity">Grant Permissions to Managed Identity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deploy-arm-template">Deploy ARM Template</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#azure-cli">Azure CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deploy-button">Deploy Button</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monitor-deployment">Monitor Deployment</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Microsoft Corporation
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>